<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependency Graph - Interactive Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px; background: #f8fafc;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .diagram-section { 
            background: white; margin: 20px 0; padding: 20px; 
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .diagram-title { 
            color: #1e293b; font-size: 24px; font-weight: 600; 
            margin-bottom: 15px; border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }
        .deps-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin: 20px 0;
        }
        .dep-category {
            padding: 15px; border-radius: 8px; border-left: 4px solid;
        }
        .core { border-color: #2e7d32; background: #e8f5e8; }
        .ml { border-color: #f57c00; background: #fff3e0; }
        .vectordb { border-color: #7b1fa2; background: #f3e5f5; }
        .text { border-color: #d32f2f; background: #ffebee; }
        .infra { border-color: #1976d2; background: #e3f2fd; }
        .category-title { font-weight: 600; margin-bottom: 10px; font-size: 16px; }
        .dep-list { font-size: 13px; line-height: 1.6; }
        .dep-item { margin: 3px 0; }
        .version { color: #666; font-size: 11px; }
        pre { 
            background: #1e293b; color: #f1f5f9; padding: 15px; 
            border-radius: 6px; overflow-x: auto; font-size: 11px;
        }
        .module-tree {
            font-family: 'Courier New', monospace; background: #fafafa;
            padding: 15px; border-radius: 6px; margin: 15px 0;
            border: 1px solid #e2e8f0; font-size: 12px; line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #1e293b; margin-bottom: 40px;">
            ğŸ“¦ Dependency Graph & Module Structure
        </h1>

        <div class="diagram-section">
            <div class="diagram-title">ğŸŒ Module Dependency Graph</div>
            <div class="mermaid">
                graph TD
                    subgraph "Entry Points"
                        MAIN[main.rs<br/>CLI Interface]
                        LIB[lib.rs<br/>Library Root]
                        BINS[Binary Crates<br/>tantivy_migrator<br/>verify_symbols<br/>test_*]
                    end

                    subgraph "Core Modules"
                        ERROR[error.rs<br/>Error Types]
                        CONFIG[config/<br/>Safe Config<br/>Feature Flags]
                        UTILS[utils/<br/>Memory<br/>Retry Logic]
                    end

                    subgraph "Search Engine"
                        SEARCH[search/<br/>Search Orchestration]
                        UNIFIED[unified.rs<br/>4-Method Coordinator]
                        TANTIVY_MOD[tantivy_search.rs<br/>Full-text Search]
                        BM25_MOD[bm25.rs<br/>Statistical Search]
                        SYMBOL_MOD[symbol_*.rs<br/>AST Analysis]
                        FUSION_MOD[fusion.rs<br/>Score Combination]
                    end

                    subgraph "Data Processing"
                        CHUNKING[chunking/<br/>Text Segmentation]
                        REGEX_CHUNK[regex_chunker.rs<br/>Code Splitting]
                        THREE_CHUNK[three_chunk.rs<br/>Context Expansion]
                        LINE_VALID[line_validator.rs<br/>Content Validation]
                    end

                    subgraph "Storage Layer"
                        STORAGE[storage/<br/>Persistence]
                        LANCEDB[lancedb*.rs<br/>Vector Storage]
                        VECTORDB[*_vectordb.rs<br/>DB Adapters]
                        CACHE_STORAGE[Caching Layer<br/>Bounded/LRU]
                    end

                    subgraph "ML & Embedding"
                        EMBEDDING[embedding/<br/>ML Models]
                        NOMIC[nomic.rs<br/>all-MiniLM-L6-v2]
                        EMBED_CACHE[cache.rs<br/>Embedding Cache]
                    end

                    subgraph "Infrastructure"
                        GIT[git/<br/>Change Detection]
                        WATCHER[watcher.rs<br/>File Monitoring]
                        OBSERVABILITY[observability/<br/>Logging/Metrics]
                        CACHE_MOD[cache/<br/>Multi-layer Cache]
                    end

                    %% Main dependencies
                    MAIN --> LIB
                    MAIN --> CONFIG
                    LIB --> ERROR
                    LIB --> SEARCH
                    LIB --> CHUNKING
                    LIB --> STORAGE
                    LIB --> EMBEDDING
                    LIB --> GIT
                    LIB --> OBSERVABILITY
                    LIB --> UTILS

                    %% Search module dependencies
                    SEARCH --> UNIFIED
                    UNIFIED --> TANTIVY_MOD
                    UNIFIED --> BM25_MOD
                    UNIFIED --> SYMBOL_MOD
                    UNIFIED --> FUSION_MOD
                    UNIFIED --> CACHE_MOD

                    %% Data flow dependencies
                    CHUNKING --> REGEX_CHUNK
                    CHUNKING --> THREE_CHUNK
                    CHUNKING --> LINE_VALID
                    THREE_CHUNK --> UNIFIED

                    %% Storage dependencies
                    STORAGE --> LANCEDB
                    STORAGE --> VECTORDB
                    STORAGE --> CACHE_STORAGE
                    EMBEDDING --> NOMIC
                    EMBEDDING --> EMBED_CACHE

                    %% Infrastructure dependencies
                    GIT --> WATCHER
                    WATCHER --> CHUNKING
                    OBSERVABILITY --> SEARCH
                    CACHE_MOD --> STORAGE

                    %% Binary dependencies
                    BINS --> CONFIG
                    BINS --> SEARCH
                    BINS --> STORAGE

                    classDef entry fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
                    classDef core fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
                    classDef search fill:#fff3e0,stroke:#f57c00,stroke-width:2px
                    classDef processing fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
                    classDef storage fill:#ffebee,stroke:#d32f2f,stroke-width:2px
                    classDef ml fill:#fce4ec,stroke:#c2185b,stroke-width:2px
                    classDef infra fill:#fafafa,stroke:#616161,stroke-width:2px

                    class MAIN,LIB,BINS entry
                    class ERROR,CONFIG,UTILS core
                    class SEARCH,UNIFIED,TANTIVY_MOD,BM25_MOD,SYMBOL_MOD,FUSION_MOD search
                    class CHUNKING,REGEX_CHUNK,THREE_CHUNK,LINE_VALID processing
                    class STORAGE,LANCEDB,VECTORDB,CACHE_STORAGE storage
                    class EMBEDDING,NOMIC,EMBED_CACHE ml
                    class GIT,WATCHER,OBSERVABILITY,CACHE_MOD infra
            </div>
        </div>

        <div class="diagram-section">
            <div class="diagram-title">ğŸ“‹ Dependency Categories by Feature Flags</div>
            <div class="deps-grid">
                <div class="dep-category core">
                    <div class="category-title">ğŸ”§ Core Dependencies (always included)</div>
                    <div class="dep-list">
                        <div class="dep-item">â€¢ <strong>tokio</strong> <span class="version">1.43</span> - Async runtime</div>
                        <div class="dep-item">â€¢ <strong>serde</strong> <span class="version">1.0</span> - Serialization</div>
                        <div class="dep-item">â€¢ <strong>anyhow</strong> <span class="version">1.0</span> - Error handling</div>
                        <div class="dep-item">â€¢ <strong>regex</strong> <span class="version">1.11</span> - Pattern matching</div>
                        <div class="dep-item">â€¢ <strong>clap</strong> <span class="version">4.4</span> - CLI parsing</div>
                        <div class="dep-item">â€¢ <strong>chrono</strong> <span class="version">0.4</span> - Date/time</div>
                        <div class="dep-item">â€¢ <strong>rayon</strong> <span class="version">1.7</span> - Parallelism</div>
                        <div class="dep-item">â€¢ <strong>walkdir</strong> <span class="version">2.4</span> - Directory traversal</div>
                    </div>
                </div>

                <div class="dep-category ml">
                    <div class="category-title">ğŸ§  ML Dependencies (ml feature)</div>
                    <div class="dep-list">
                        <div class="dep-item">â€¢ <strong>candle-core</strong> <span class="version">0.9</span> - ML framework</div>
                        <div class="dep-item">â€¢ <strong>candle-nn</strong> <span class="version">0.9</span> - Neural networks</div>
                        <div class="dep-item">â€¢ <strong>candle-transformers</strong> <span class="version">0.9</span> - Transformer models</div>
                        <div class="dep-item">â€¢ <strong>tokenizers</strong> <span class="version">0.21</span> - Text tokenization</div>
                        <div class="dep-item">â€¢ <strong>hf-hub</strong> <span class="version">0.3</span> - Model downloading</div>
                        <div class="dep-item">â€¢ <strong>reqwest</strong> <span class="version">0.11</span> - HTTP client</div>
                        <div class="dep-item">â€¢ <strong>memmap2</strong> <span class="version">0.9</span> - Memory mapping</div>
                    </div>
                </div>

                <div class="dep-category vectordb">
                    <div class="category-title">ğŸ—ƒï¸ Vector DB Dependencies (vectordb feature)</div>
                    <div class="dep-list">
                        <div class="dep-item">â€¢ <strong>lancedb</strong> <span class="version">0.21.2</span> - Vector database</div>
                        <div class="dep-item">â€¢ <strong>arrow</strong> <span class="version">55.0</span> - Columnar format</div>
                        <div class="dep-item">â€¢ <strong>arrow-array</strong> <span class="version">55.0</span> - Array operations</div>
                        <div class="dep-item">â€¢ <strong>arrow-schema</strong> <span class="version">55.0</span> - Schema definition</div>
                        <div class="dep-item">â€¢ <strong>sled</strong> <span class="version">0.34</span> - Legacy storage</div>
                    </div>
                </div>

                <div class="dep-category text">
                    <div class="category-title">ğŸ“ Text Search Dependencies (tantivy feature)</div>
                    <div class="dep-list">
                        <div class="dep-item">â€¢ <strong>tantivy</strong> <span class="version">0.24</span> - Full-text search</div>
                        <div class="dep-item">â€¢ <strong>tantivy-jieba</strong> <span class="version">0.16</span> - CJK tokenization</div>
                        <div class="dep-item">â€¢ <strong>rust-stemmers</strong> <span class="version">1.2</span> - Word stemming</div>
                        <div class="dep-item">â€¢ <strong>unicode-normalization</strong> <span class="version">0.1</span> - Text normalization</div>
                        <div class="dep-item">â€¢ <strong>unicode-segmentation</strong> <span class="version">1.10</span> - Text segmentation</div>
                    </div>
                </div>

                <div class="dep-category infra">
                    <div class="category-title">ğŸ” Symbol Parsing Dependencies (tree-sitter feature)</div>
                    <div class="dep-list">
                        <div class="dep-item">â€¢ <strong>tree-sitter</strong> <span class="version">0.23</span> - Parser framework</div>
                        <div class="dep-item">â€¢ <strong>tree-sitter-rust</strong> <span class="version">0.23</span> - Rust parser</div>
                        <div class="dep-item">â€¢ <strong>tree-sitter-python</strong> <span class="version">0.23</span> - Python parser</div>
                        <div class="dep-item">â€¢ <strong>tree-sitter-javascript</strong> <span class="version">0.23</span> - JS parser</div>
                        <div class="dep-item">â€¢ <strong>tree-sitter-typescript</strong> <span class="version">0.23</span> - TS parser</div>
                        <div class="dep-item">â€¢ <strong>tree-sitter-go</strong> <span class="version">0.23</span> - Go parser</div>
                        <div class="dep-item">â€¢ Plus 6 more language parsers...</div>
                    </div>
                </div>

                <div class="dep-category infra">
                    <div class="category-title">âš™ï¸ Infrastructure Dependencies</div>
                    <div class="dep-list">
                        <div class="dep-item">â€¢ <strong>tracing</strong> <span class="version">0.1</span> - Structured logging</div>
                        <div class="dep-item">â€¢ <strong>tracing-subscriber</strong> <span class="version">0.3</span> - Log collection</div>
                        <div class="dep-item">â€¢ <strong>sysinfo</strong> <span class="version">0.30</span> - System monitoring</div>
                        <div class="dep-item">â€¢ <strong>parking_lot</strong> <span class="version">0.12</span> - Thread-safe primitives</div>
                        <div class="dep-item">â€¢ <strong>lru</strong> <span class="version">0.12</span> - LRU cache</div>
                        <div class="dep-item">â€¢ <strong>backoff</strong> <span class="version">0.4</span> - Retry logic</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="diagram-section">
            <div class="diagram-title">ğŸ“ Source Code Module Tree</div>
            <div class="module-tree">
src/
â”œâ”€â”€ ğŸ“ bin/                     # Binary executables
â”‚   â”œâ”€â”€ tantivy_migrator.rs     # Index migration tool
â”‚   â”œâ”€â”€ verify_symbols.rs       # Symbol verification
â”‚   â””â”€â”€ test_*.rs              # Testing utilities
â”œâ”€â”€ ğŸ“ cache/                   # Caching system
â”‚   â””â”€â”€ bounded_cache.rs        # Memory-bounded LRU cache
â”œâ”€â”€ ğŸ“ chunking/                # Text/code segmentation
â”‚   â”œâ”€â”€ mod.rs                 # Module interface
â”‚   â”œâ”€â”€ regex_chunker.rs       # Regex-based splitting
â”‚   â”œâ”€â”€ three_chunk.rs         # Context expansion (55% improvement)
â”‚   â””â”€â”€ line_validator.rs      # Content validation
â”œâ”€â”€ ğŸ“ config/                  # Configuration management
â”‚   â”œâ”€â”€ mod.rs                 # Config interface
â”‚   â””â”€â”€ safe_config.rs         # Feature flag safety
â”œâ”€â”€ ğŸ“ embedding/               # ML embeddings [ml feature]
â”‚   â”œâ”€â”€ mod.rs                 # Embedding interface
â”‚   â”œâ”€â”€ nomic.rs              # all-MiniLM-L6-v2 integration
â”‚   â””â”€â”€ cache.rs              # Embedding result caching
â”œâ”€â”€ ğŸ“ git/                     # Version control integration
â”‚   â”œâ”€â”€ mod.rs                 # Git interface
â”‚   â””â”€â”€ watcher.rs            # File change detection
â”œâ”€â”€ ğŸ“ observability/          # Monitoring & logging
â”‚   â”œâ”€â”€ mod.rs                 # Observability interface
â”‚   â”œâ”€â”€ logging.rs            # Structured logging setup
â”‚   â””â”€â”€ metrics.rs            # Performance metrics
â”œâ”€â”€ ğŸ“ search/                  # Core search engine
â”‚   â”œâ”€â”€ mod.rs                 # Search module interface
â”‚   â”œâ”€â”€ unified.rs            # 4-method parallel coordinator â­
â”‚   â”œâ”€â”€ tantivy_search.rs     # Full-text search [tantivy feature]
â”‚   â”œâ”€â”€ bm25.rs               # Statistical TF-IDF search
â”‚   â”œâ”€â”€ symbol_*.rs           # Symbol-based search [tree-sitter]
â”‚   â”œâ”€â”€ fusion.rs             # Score combination algorithm
â”‚   â”œâ”€â”€ cache.rs              # Search result caching
â”‚   â”œâ”€â”€ preprocessing.rs      # Query normalization
â”‚   â””â”€â”€ search_adapter.rs     # Interface adapters
â”œâ”€â”€ ğŸ“ storage/                 # Data persistence
â”‚   â”œâ”€â”€ mod.rs                 # Storage interface
â”‚   â”œâ”€â”€ lancedb*.rs           # Vector database [vectordb feature]
â”‚   â”œâ”€â”€ *_vectordb.rs         # Vector storage adapters
â”‚   â””â”€â”€ lightweight_storage.rs # Minimal storage implementation
â”œâ”€â”€ ğŸ“ utils/                   # Utilities
â”‚   â”œâ”€â”€ mod.rs                 # Utils interface
â”‚   â”œâ”€â”€ memory.rs             # Memory management
â”‚   â””â”€â”€ retry.rs              # Exponential backoff retry
â”œâ”€â”€ lib.rs                     # Library root & module orchestration
â”œâ”€â”€ main.rs                    # CLI entry point
â””â”€â”€ error.rs                   # Error type definitions

ğŸ¯ Key Architecture Points:
â”œâ”€â”€ Modular design with clear separation of concerns
â”œâ”€â”€ Feature flags control compilation and dependencies
â”œâ”€â”€ Async/await throughout with tokio runtime
â”œâ”€â”€ Thread-safe patterns with Arc<RwLock<T>>
â”œâ”€â”€ Comprehensive error handling with anyhow/thiserror
â””â”€â”€ Production-ready observability and metrics
            </div>
        </div>

        <div class="diagram-section">
            <div class="diagram-title">âš™ï¸ Compilation Feature Matrix</div>
            <pre>
ğŸš© Feature Flag Impact on Build:

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ Feature Combo   â”‚ Core    â”‚ ML     â”‚ VectorDBâ”‚ Tantivy     â”‚ Tree-sitter      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ core (default)  â”‚ âœ…      â”‚ âŒ     â”‚ âŒ      â”‚ âŒ          â”‚ âŒ               â”‚
â”‚ search-basic    â”‚ âœ…      â”‚ âŒ     â”‚ âŒ      â”‚ âœ…          â”‚ âŒ               â”‚
â”‚ search-advanced â”‚ âœ…      â”‚ âŒ     â”‚ âŒ      â”‚ âœ…          â”‚ âœ…               â”‚
â”‚ full-system     â”‚ âœ…      â”‚ âœ…     â”‚ âœ…      â”‚ âœ…          â”‚ âœ…               â”‚
â”‚ test-integrationâ”‚ âœ…      â”‚ âœ…     â”‚ âœ…      â”‚ âœ…          â”‚ âœ…               â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

ğŸ“¦ Dependency Count by Feature:
â”œâ”€â”€ core: 20 crates (minimal, fast compilation)
â”œâ”€â”€ +tantivy: +5 crates (text search capabilities)
â”œâ”€â”€ +tree-sitter: +12 crates (multi-language AST parsing) 
â”œâ”€â”€ +ml: +8 crates (embedding models, significant size)
â”œâ”€â”€ +vectordb: +5 crates (vector storage, Arrow ecosystem)
â””â”€â”€ full-system: 50+ crates (complete functionality)

â±ï¸ Compilation Time Impact:
â”œâ”€â”€ core: ~30s (baseline)
â”œâ”€â”€ +tantivy: +15s (text indexing)
â”œâ”€â”€ +tree-sitter: +25s (language parsers)
â”œâ”€â”€ +ml: +90s (ML frameworks, model files)
â””â”€â”€ full-system: ~2-3 minutes (complete build)

ğŸ’¾ Binary Size Impact:
â”œâ”€â”€ core: ~5MB (minimal footprint)
â”œâ”€â”€ +features: 15-25MB (with all features)
â””â”€â”€ +models: +500MB (embedding model files)
            </pre>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#1e293b',
                primaryBorderColor: '#2563eb',
                lineColor: '#64748b',
                secondaryColor: '#f8fafc',
                tertiaryColor: '#e2e8f0'
            },
            flowchart: {
                curve: 'basis',
                nodeSpacing: 50,
                rankSpacing: 80
            }
        });
    </script>
</body>
</html>