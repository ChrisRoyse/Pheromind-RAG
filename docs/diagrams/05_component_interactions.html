<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Component Interactions - System Integration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px; background: #f8fafc;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .diagram-section { 
            background: white; margin: 20px 0; padding: 20px; 
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .diagram-title { 
            color: #1e293b; font-size: 24px; font-weight: 600; 
            margin-bottom: 15px; border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }
        .interaction-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin: 20px 0;
        }
        .interaction-card {
            padding: 15px; border-radius: 8px; border-left: 4px solid;
            background: #f8fafc; border: 1px solid #e2e8f0;
        }
        .search { border-left-color: #f57c00; }
        .storage { border-left-color: #d32f2f; }
        .processing { border-left-color: #2e7d32; }
        .infrastructure { border-left-color: #7b1fa2; }
        .card-title { font-weight: 600; margin-bottom: 8px; color: #1e293b; }
        .card-content { font-size: 13px; line-height: 1.6; color: #64748b; }
        pre {
            background: #1e293b; color: #f1f5f9; padding: 15px;
            border-radius: 6px; overflow-x: auto; font-size: 11px;
        }
        .data-flow {
            display: flex; align-items: center; margin: 10px 0;
            padding: 10px; background: #f1f5f9; border-radius: 6px;
            font-size: 12px;
        }
        .flow-step {
            flex: 1; text-align: center; padding: 5px;
            background: white; margin: 0 5px; border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
        .arrow { font-size: 16px; color: #64748b; }
        .performance-metrics {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px; margin: 15px 0;
        }
        .metric {
            text-align: center; padding: 10px; background: #f8fafc;
            border-radius: 6px; border: 1px solid #e2e8f0;
        }
        .metric-value { font-size: 18px; font-weight: bold; color: #3b82f6; }
        .metric-label { font-size: 11px; color: #64748b; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #1e293b; margin-bottom: 40px;">
            üîó Component Interactions - System Integration Patterns
        </h1>

        <div class="diagram-section">
            <div class="diagram-title">üåê High-Level System Interactions</div>
            <div class="mermaid">
                graph TB
                    subgraph "Client Interface Layer"
                        CLI[CLI Application<br/>Command Processing]
                        MCP[MCP Server<br/>Protocol Handler]
                        API[REST API<br/>HTTP Interface]
                    end

                    subgraph "Request Processing Layer"
                        ROUTER[Request Router<br/>Command Dispatching]
                        VALIDATOR[Input Validator<br/>Request Sanitization]
                        AUTH[Authentication<br/>Access Control]
                    end

                    subgraph "Search Orchestration Layer"
                        ORCHESTRATOR[Search Orchestrator<br/>unified.rs]
                        PREPROCESSOR[Query Preprocessor<br/>Text Normalization]
                        FUSION[Result Fusion<br/>Score Combination]
                    end

                    subgraph "Parallel Search Engines"
                        TANTIVY_ENG[Tantivy Engine<br/>Full-text Search]
                        SEMANTIC_ENG[Semantic Engine<br/>Vector Similarity]
                        SYMBOL_ENG[Symbol Engine<br/>AST Analysis]
                        BM25_ENG[BM25 Engine<br/>Statistical Ranking]
                    end

                    subgraph "Storage & Caching Layer"
                        LANCE_STORE[LanceDB Storage<br/>Vector Persistence]
                        TANTIVY_IDX[Tantivy Index<br/>Inverted Index]
                        SYMBOL_STORE[Symbol Store<br/>AST Cache]
                        MEMORY_CACHE[Memory Cache<br/>Multi-layer LRU]
                    end

                    subgraph "Data Processing Layer"
                        CHUNKER[Content Chunker<br/>Text Segmentation]
                        CONTEXT_EXP[Context Expander<br/>3-Chunk System]
                        EMBEDDER[Embedding Generator<br/>all-MiniLM-L6-v2]
                        INDEXER[Content Indexer<br/>Multi-format Support]
                    end

                    subgraph "Infrastructure Layer"
                        FILE_WATCHER[File Watcher<br/>Change Detection]
                        CONFIG_MGR[Config Manager<br/>Feature Flags]
                        LOGGER[Logger<br/>Structured Logging]
                        METRICS[Metrics Collector<br/>Performance Monitoring]
                        MEMORY_MGR[Memory Manager<br/>Resource Control]
                    end

                    %% Client to Processing
                    CLI --> ROUTER
                    MCP --> ROUTER
                    API --> ROUTER
                    ROUTER --> VALIDATOR
                    VALIDATOR --> AUTH
                    AUTH --> ORCHESTRATOR

                    %% Search orchestration
                    ORCHESTRATOR --> PREPROCESSOR
                    PREPROCESSOR --> TANTIVY_ENG
                    PREPROCESSOR --> SEMANTIC_ENG
                    PREPROCESSOR --> SYMBOL_ENG
                    PREPROCESSOR --> BM25_ENG

                    %% Parallel execution results
                    TANTIVY_ENG --> FUSION
                    SEMANTIC_ENG --> FUSION
                    SYMBOL_ENG --> FUSION
                    BM25_ENG --> FUSION

                    %% Storage connections
                    TANTIVY_ENG --> TANTIVY_IDX
                    SEMANTIC_ENG --> LANCE_STORE
                    SYMBOL_ENG --> SYMBOL_STORE
                    BM25_ENG --> MEMORY_CACHE

                    %% Data processing connections
                    CHUNKER --> CONTEXT_EXP
                    CONTEXT_EXP --> INDEXER
                    EMBEDDER --> LANCE_STORE
                    INDEXER --> TANTIVY_IDX
                    INDEXER --> SYMBOL_STORE

                    %% Infrastructure connections
                    FILE_WATCHER --> CHUNKER
                    CONFIG_MGR --> ORCHESTRATOR
                    LOGGER --> ORCHESTRATOR
                    METRICS --> ORCHESTRATOR
                    MEMORY_MGR --> MEMORY_CACHE

                    classDef client fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
                    classDef processing fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
                    classDef orchestration fill:#fff3e0,stroke:#f57c00,stroke-width:2px
                    classDef search fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
                    classDef storage fill:#ffebee,stroke:#d32f2f,stroke-width:2px
                    classDef data fill:#fce4ec,stroke:#c2185b,stroke-width:2px
                    classDef infra fill:#fafafa,stroke:#616161,stroke-width:2px

                    class CLI,MCP,API client
                    class ROUTER,VALIDATOR,AUTH processing
                    class ORCHESTRATOR,PREPROCESSOR,FUSION orchestration
                    class TANTIVY_ENG,SEMANTIC_ENG,SYMBOL_ENG,BM25_ENG search
                    class LANCE_STORE,TANTIVY_IDX,SYMBOL_STORE,MEMORY_CACHE storage
                    class CHUNKER,CONTEXT_EXP,EMBEDDER,INDEXER data
                    class FILE_WATCHER,CONFIG_MGR,LOGGER,METRICS,MEMORY_MGR infra
            </div>
        </div>

        <div class="diagram-section">
            <div class="diagram-title">‚ö° Search Request Flow - Detailed Interaction</div>
            <div class="mermaid">
                sequenceDiagram
                    participant U as User
                    participant CLI as CLI Interface
                    participant R as Router
                    participant O as Orchestrator
                    participant P as Preprocessor
                    participant TE as Tantivy Engine
                    participant SE as Semantic Engine
                    participant SYM as Symbol Engine
                    participant BM as BM25 Engine
                    participant F as Fusion
                    participant C as Context Expander

                    U->>CLI: search "async function"
                    CLI->>R: Process command
                    R->>O: Route search request
                    O->>P: Normalize query
                    P-->>O: "async", "function" tokens
                    
                    Note over O: Parallel Search Execution
                    par Parallel Execution
                        O->>TE: Full-text search
                        TE-->>O: Tantivy results
                    and
                        O->>SE: Semantic search  
                        SE-->>O: Vector results
                    and
                        O->>SYM: Symbol search
                        SYM-->>O: AST results
                    and
                        O->>BM: Statistical search
                        BM-->>O: BM25 results
                    end
                    
                    O->>F: Combine results
                    F->>C: Expand context
                    C-->>F: 3-chunk results
                    F-->>O: Ranked results
                    O-->>CLI: Final results
                    CLI-->>U: Display results

                    rect rgb(240, 248, 255)
                    Note over O,BM: ~50-200ms parallel execution
                    end
            </div>
        </div>

        <div class="diagram-section">
            <div class="diagram-title">üìä Component Interaction Patterns</div>
            <div class="interaction-grid">
                <div class="interaction-card search">
                    <div class="card-title">üîç Search Engine Interactions</div>
                    <div class="card-content">
                        <strong>Unified Orchestrator Pattern:</strong><br/>
                        ‚Ä¢ Single entry point for all search methods<br/>
                        ‚Ä¢ Parallel execution using tokio::join!<br/>
                        ‚Ä¢ Result aggregation and deduplication<br/>
                        ‚Ä¢ Score normalization across methods<br/>
                        ‚Ä¢ Timeout handling for individual engines
                    </div>
                </div>

                <div class="interaction-card storage">
                    <div class="card-title">üíæ Storage Layer Interactions</div>
                    <div class="card-content">
                        <strong>Multi-Store Architecture:</strong><br/>
                        ‚Ä¢ LanceDB: Vector embeddings (384-dim)<br/>
                        ‚Ä¢ Tantivy: Inverted text index<br/>
                        ‚Ä¢ Symbol Store: AST structure cache<br/>
                        ‚Ä¢ Memory Cache: Hot data LRU<br/>
                        ‚Ä¢ Consistent read/write patterns
                    </div>
                </div>

                <div class="interaction-card processing">
                    <div class="card-title">‚öôÔ∏è Processing Pipeline Interactions</div>
                    <div class="card-content">
                        <strong>Stream Processing Pattern:</strong><br/>
                        ‚Ä¢ File changes trigger chunking<br/>
                        ‚Ä¢ Content flows through 3-chunk expander<br/>
                        ‚Ä¢ Parallel indexing to multiple stores<br/>
                        ‚Ä¢ Incremental updates minimize reprocessing<br/>
                        ‚Ä¢ Error isolation prevents cascade failures
                    </div>
                </div>

                <div class="interaction-card infrastructure">
                    <div class="card-title">üèóÔ∏è Infrastructure Interactions</div>
                    <div class="card-content">
                        <strong>Cross-Cutting Concerns:</strong><br/>
                        ‚Ä¢ Config management with feature flags<br/>
                        ‚Ä¢ Structured logging with tracing<br/>
                        ‚Ä¢ Resource monitoring and limits<br/>
                        ‚Ä¢ Performance metrics collection<br/>
                        ‚Ä¢ Graceful shutdown coordination
                    </div>
                </div>
            </div>
        </div>

        <div class="diagram-section">
            <div class="diagram-title">üîÑ Data Flow Patterns</div>
            
            <h4 style="color: #1e293b; margin-top: 25px;">üì• Indexing Flow (File Changes ‚Üí Storage)</h4>
            <div class="data-flow">
                <div class="flow-step">Git Change<br/>Detection</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">File<br/>Chunking</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">3-Chunk<br/>Context</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Parallel<br/>Indexing</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Multi-Store<br/>Update</div>
            </div>

            <h4 style="color: #1e293b; margin-top: 25px;">üîç Search Flow (Query ‚Üí Results)</h4>
            <div class="data-flow">
                <div class="flow-step">Query<br/>Input</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Text<br/>Preprocessing</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">4-Method<br/>Parallel</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Score<br/>Fusion</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Context<br/>Enhanced</div>
            </div>

            <h4 style="color: #1e293b; margin-top: 25px;">üß† ML Embedding Flow (Text ‚Üí Vectors)</h4>
            <div class="data-flow">
                <div class="flow-step">Text<br/>Chunks</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Cache<br/>Check</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">MiniLM<br/>Embedding</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Vector<br/>Storage</div>
                <div class="arrow">‚Üí</div>
                <div class="flow-step">Cache<br/>Update</div>
            </div>
        </div>

        <div class="diagram-section">
            <div class="diagram-title">üìà Performance & Concurrency Characteristics</div>
            <div class="performance-metrics">
                <div class="metric">
                    <div class="metric-value">4x</div>
                    <div class="metric-label">Parallel Search Methods</div>
                </div>
                <div class="metric">
                    <div class="metric-value">&lt;500ms</div>
                    <div class="metric-label">Average Search Time</div>
                </div>
                <div class="metric">
                    <div class="metric-value">98.6%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric">
                    <div class="metric-value">55%</div>
                    <div class="metric-label">Context Improvement</div>
                </div>
                <div class="metric">
                    <div class="metric-value">384</div>
                    <div class="metric-label">Vector Dimensions</div>
                </div>
                <div class="metric">
                    <div class="metric-value">&lt;2GB</div>
                    <div class="metric-label">Memory Target</div>
                </div>
            </div>

            <pre>
üîß Concurrency & Integration Patterns:

‚îú‚îÄ‚îÄ üöÄ Async/Await Throughout
‚îÇ   ‚îú‚îÄ‚îÄ Tokio runtime for all I/O operations
‚îÇ   ‚îú‚îÄ‚îÄ Non-blocking file system operations
‚îÇ   ‚îú‚îÄ‚îÄ Parallel search execution with join!
‚îÇ   ‚îî‚îÄ‚îÄ Streaming results for large datasets
‚îÇ
‚îú‚îÄ‚îÄ üîí Thread-Safe Data Structures
‚îÇ   ‚îú‚îÄ‚îÄ Arc<RwLock<T>> for shared mutable state
‚îÇ   ‚îú‚îÄ‚îÄ Atomic operations for counters/flags
‚îÇ   ‚îú‚îÄ‚îÄ Channel-based inter-component communication
‚îÇ   ‚îî‚îÄ‚îÄ Lock-free data structures where possible
‚îÇ
‚îú‚îÄ‚îÄ üéØ Resource Management
‚îÇ   ‚îú‚îÄ‚îÄ Bounded memory caches with LRU eviction
‚îÇ   ‚îú‚îÄ‚îÄ Connection pooling for database access
‚îÇ   ‚îú‚îÄ‚îÄ Configurable timeouts and retries
‚îÇ   ‚îú‚îÄ‚îÄ Graceful shutdown with cleanup
‚îÇ   ‚îî‚îÄ‚îÄ Memory monitoring and adaptive limits
‚îÇ
‚îú‚îÄ‚îÄ üìä Error Handling & Recovery
‚îÇ   ‚îú‚îÄ‚îÄ Structured error types with context
‚îÇ   ‚îú‚îÄ‚îÄ Component isolation prevents cascading failures
‚îÇ   ‚îú‚îÄ‚îÄ Circuit breaker pattern for external services
‚îÇ   ‚îú‚îÄ‚îÄ Exponential backoff for transient failures
‚îÇ   ‚îî‚îÄ‚îÄ Comprehensive logging for diagnostics
‚îÇ
‚îî‚îÄ‚îÄ üîÑ Integration Patterns
    ‚îú‚îÄ‚îÄ Pub/Sub for loose coupling between components
    ‚îú‚îÄ‚îÄ Command pattern for request processing
    ‚îú‚îÄ‚îÄ Strategy pattern for search method selection
    ‚îú‚îÄ‚îÄ Observer pattern for file change notifications
    ‚îî‚îÄ‚îÄ Factory pattern for feature-flag based instantiation

‚ö° Performance Optimizations:

‚îú‚îÄ‚îÄ üß† Smart Caching Strategy
‚îÇ   ‚îú‚îÄ‚îÄ Multi-layer cache hierarchy (L1: Memory, L2: Disk)
‚îÇ   ‚îú‚îÄ‚îÄ Embedding cache reduces ML inference by 80%
‚îÇ   ‚îú‚îÄ‚îÄ Query result cache for repeated searches
‚îÇ   ‚îî‚îÄ‚îÄ Adaptive cache sizing based on available memory
‚îÇ
‚îú‚îÄ‚îÄ üîç Search Optimizations
‚îÇ   ‚îú‚îÄ‚îÄ Early termination for low-confidence results
‚îÇ   ‚îú‚îÄ‚îÄ Bloom filters for negative hit optimization
‚îÇ   ‚îú‚îÄ‚îÄ Index warming for commonly accessed data
‚îÇ   ‚îî‚îÄ‚îÄ Parallel index updates for high-throughput scenarios
‚îÇ
‚îî‚îÄ‚îÄ üìà Monitoring & Observability
    ‚îú‚îÄ‚îÄ Structured logging with correlation IDs
    ‚îú‚îÄ‚îÄ Performance metrics with percentile tracking
    ‚îú‚îÄ‚îÄ Resource usage monitoring and alerting
    ‚îú‚îÄ‚îÄ Distributed tracing for multi-component requests
    ‚îî‚îÄ‚îÄ Health checks for all critical components
            </pre>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#1e293b',
                primaryBorderColor: '#2563eb',
                lineColor: '#64748b',
                secondaryColor: '#f8fafc',
                tertiaryColor: '#e2e8f0'
            },
            flowchart: {
                curve: 'basis',
                nodeSpacing: 50,
                rankSpacing: 70
            },
            sequence: {
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });
    </script>
</body>
</html>